# SI 699 - DTE Aerial Photo Collection Digital Curation project
# Batch Processing Workflow Proof of Concept

## Purpose of Scripts

These scripts were written as part of a digital curation project for a mastery course at the University of Michigan School of Information. Our client, Wayne State University Libraries Digital Collections unit, had asked us to investigate the PDF files that comprise the [DTE Aerial Photo Collection](https://digital.library.wayne.edu/dte_aerial/). To assist with migrating the collection into the library's collection platform, we were asked to investigate whether the aerial photograph PDFs had embedded image files that could be extracted and how we might recreate the information contained with the index map PDFs in records for each individual image.

The Python scripts contained with this repository are designed to solve both of these tasks. **extract_using_pypdf.py** and **extract_using_poppler.py** represent two scripts capable of programmatically extracting JPEG bytestreams and image metadata from the photo PDFs and document and link metadata from the index PDFs in a target directory. **georeference_links.py** uses the link metadata generated by the extraction scripts to convert internal PDF coordinates into geocoordinates (latitude-longitude pairs). **process_batch.py** integrates the workflows laid out in the extract_using_pypdf.py and georeference_links.py scripts and combines the results of both into comprehensive image-level records for each new JPEG file created. Each script -- its dependencies, its inputs and outputs, and how to run it -- is described in detail below.

## Script Descriptions

### process_batch.py

This script is designed to process the contents of a target directory in the DTE Aerial Collection, where there will be one index PDF and some number of image PDFs linked to in the index PDF. The script imports the extract_using_pypdf.py and georeference_links.py scripts described below and executes their workflow functions, ultimately creating new JPEG files for all image PDFs and various metadata files in JSON.

#### Use

To run the script, enter the following command at your command prompt of choice,  The command line options are described below.

python process_batch.py [mode] [input path] [output path]

**mode**

There are two possible options for **mode**: "process" or "load". "process" will run the extraction and georeferencing workflows. "load" will instead open the metadata files produced by the last "process" execution.

**input path**

The value entered for **input path** should be a valid relative path from the current working directory to the target directory to process. If no value is entered for **input path** or **output path** (see below), the path used for the proof of concept ('input/pdf_files/part1/macomb/1961/') will be set.

**output path**

The value entered for **output path** should be a valid relative path from the current working directory to the target directory to process. If no value is entered for **output path** (see below), the path used for the proof of concept ('output/') will be set.

##### Fixing matches

In testing the proof of concept, we discovered that often links embedded in the index PDF will point to the wrong image PDF. When you run process_batch.py, the script will report during the matching process whether no link records were found that correspond with an image record or if multiple link records were found that correspond to an image record. If multiple are found, the PDF Object ID Numbers will be reported as well.

To correct these, the script user will need to manually investigate the mismatches and enter the correct image file identifier and PDF Object ID Number matches in manual_pairs.csv.

### extract_using_pypdf.py

Description of algorithm

#### Use

The script's Main Program runs the extraction workflow on the files in a test directory from the collection (input files are not provided).

#### Inputs
#### Outputs
#### Dependencies

This script uses [PyPDF2](https://pythonhosted.org/PyPDF2/), an open-source library for reading and writing PDF files. The entire codebase is available in a [GitHub repository](https://github.com/mstamy2/PyPDF2).

The use of PyPDF2 and some script features (particularly the bytestream extraction using an object attribute) were inspired by [an answer by sylvain to a Stack Overflow question](https://stackoverflow.com/questions/2693820/extract-images-from-pdf-without-resampling-in-python/34116472#34116472).

### extract_using_poppler.py

Description of algorithm

#### Use
#### Inputs
#### Outputs
#### Dependencies

### georeference_links.py

Description of algorithm

#### Use

The script's Main Program runs the georeferencing workflow on a user-defined batch metadata file to generate a sample JSON file.  The functions in this script are called by the primary workflow script, process_batch.py to georeference the images extracted by extract_using_pypdf.py.

#### Inputs

This script's primary function, run_georeferencing_workflow() takes as input the path to the metadata JSON file created by the run_pypdf2_workflow() function (also called by process_batch.py), the desired name of the output metadata file, and the path to the directory in which to create the output metadata file.

#### Outputs

This script's primary function, run_georeferencing_workflow() returns a data dictionary containing a) information used in the georeferncing process (two address pairs and the calculated conversion formula constants) and b) a dictionary for each image link in the index PDF containing its PDF object number, the image identifier it links to, the link's PDF coordinates, the image's calculated latitude and longitude, and the county the image is in.  The workflow function also writes this data to an output json file with name and location specified by the function's arguments.

#### Dependencies

[ArcGIS for Python Installation Guide](https://developers.arcgis.com/python/guide/install-and-set-up/)

## Script Use and Access
